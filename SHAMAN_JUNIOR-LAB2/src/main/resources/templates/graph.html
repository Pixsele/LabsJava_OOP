<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <script th:src="@{/js/scripts.js}" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Diff</title>
    <style>
        body{
            font-family: Tahoma, sans-serif;
        }
        .modalAnother {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2e2e2e;
            border-radius: 30px;
            padding: 20px;
            border: 1px solid black;
            display: none;
            z-index: 1001;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; /* По умолчанию скрыт */
            z-index: 1000;
        }

        #modalSave {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1b40f8;
            padding: 20px;
            border: 1px solid #ccc;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: 400px;
            z-index: 1001;
        }

        #modalEdit {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1b40f8;
            padding: 20px;
            border: 1px solid #ccc;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Тень для модального окна */
            width: 400px; /* Устанавливаем фиксированную ширину */
            z-index: 1001;
        }

        #modalRemove {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1b40f8;
            padding: 20px;
            border: 1px solid #ccc;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Тень для модального окна */
            width: 400px; /* Устанавливаем фиксированную ширину */
            z-index: 1001;
        }

    </style>
</head>
<body>
<h3>Функция</h3>
<div id="graphContent">
    <div th:if="${graphFunc != null}">
        <h4>Таблица функции:</h4>
        <table border="1">
            <thead>
            <tr>
                <th>X</th>
                <th>Y</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="i : ${#numbers.sequence(0, countGraph - 1)}">
                <td><input type="number" th:value="${graphFunc.getXValues()[i]}" ></td>
                <td><input type="number" th:value="${graphFunc.getYValues()[i]}" ></td>
            </tr>
            </tbody>
        </table>
    </div>
    <div th:if="${graphFunc == null}">
        <p>Отсутствует функция</p>
    </div>
    <button onclick="openModal('graph','graph')">Создать функцию</button>
    <button onclick="openSave('graph')" th:attr="disabled=${graphFunc == null}">Сохранить</button>
    <button onclick="openFunctionList('graph')">Загрузить</button>
    <button onclick="openAnother('graph','graph')">Открыть</button>
    <button onclick="openEdit('graph','graph')" th:attr="disabled=${graphFunc == null}">Вставить или изменить</button>
    <button onclick="openRemove('graph','graph')" th:attr="disabled=${graphFunc == null or countGraph == 2 }">Удалить точку</button>

</div>

<div id="functionGraphContainer">
    <canvas id="functionGraph"></canvas>
</div>


<div id="modalFunction" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid black;">
    <div id="modalContentFunction">
        <h3>Выберите функцию</h3>
        <table border="1" width="100%">
            <thead>
            <tr>
                <th>ID</th>
                <th>Имя функции</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="function : ${functions}" class="function-row"
                th:onclick="|selectFunction(this, '${function.id}', modalTarget)|">
                <td th:text="${function.getId()}"></td>
                <td th:text="${function.getName()}"></td>
            </tr>
            </tbody>
        </table>
        <button id="loadButton" onclick="loadFunction()">Загрузить</button>
        <button onclick="closeFunctionList()">Закрыть</button>
    </div>
</div>

<!-- Модальное окно -->
<div id="modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid black;">
    <div id="modalContent"></div>
    <button type="button" onclick="document.getElementById('modal').style.display = 'none'">Закрыть</button>
</div>

<div id="modalSave" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid black;">
    <div id="modalContentSave">
        <form onsubmit="saveFunction(event)">
            <label for="funcName">Название функции:</label>
            <input type="text" name="funcName" id="funcName" required>
            <button type="submit">Cохранить</button>
        </form>
    </div>
    <button onclick="closeSave()">Закрыть</button>
</div>

<div id="modalAnother" class="modalAnother">
    <div id="modalContentAnother">
    </div>
</div>

<div id="modalEdit">
    <div id="modalEditContent">
        <form onsubmit="editFunc(event)">
            <label for="xValue">Какую точку изменить:</label>
            <input type="number" name="xValue" id="xValue" required>
            <label for="yValue">На что изменить</label>
            <input type="number" name="yValue" id="yValue" required>
            <button type="submit">Cохранить</button>
        </form>
    </div>
    <button onclick="closeEdit()">Закрыть</button>
</div>

<div id="modalRemove">
    <div id="modalRemoveContent">
        <form onsubmit="removeFunc(event)">
            <label for="xToRemove">Какую точку изменить:</label>
            <input type="number" name="xValue" id="xToRemove" required>
            <button type="submit">Cохранить</button>
        </form>
    </div>
    <button onclick="closeRemove()">Закрыть</button>
</div>

<!-- Overlay для всех модальных окон -->
<div id="modalOverlay" class="modal-overlay"></div>

<div th:if="${showError}">
    <div th:replace="fragments/errorForm"></div>
    <script>
        document.getElementById('errorForm').style.display = 'block';
    </script>
</div>

<div th:replace="fragments/errorForm"></div>

</body>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const canvas = document.getElementById('functionGraph').getContext('2d');

        // Инициализация графика
        const chart = new Chart(canvas, {
            type: 'line',
            data: {
                labels: [], // Здесь будут X значения
                datasets: [{
                    label: 'Функция',
                    data: [], // Здесь будут Y значения
                    borderColor: 'blue',
                    borderWidth: 2,
                    fill: false,
                }],
            },
            options: {
                responsive: true,
                scales: {
                    x: { title: { display: true, text: 'X' } },
                    y: { title: { display: true, text: 'Y' } },
                },
            },
        });

        // Функция обновления графика
        function updateGraph() {
            const rows = document.querySelectorAll('tbody tr');
            console.log(rows);
            const xValues = [];
            const yValues = [];

            rows.forEach(row => {
                const xInput = row.cells[0].querySelector('input'); // Значение из первой ячейки (X)
                const yInput = row.cells[1].querySelector('input'); // Значение из второй ячейки (Y)

                if (xInput && yInput) {
                    console.log(`X: ${xInput.value}, Y: ${yInput.value}`);

                    const x = parseInt(yInput.value);
                    const y = parseInt(yInput.value);

                    xValues.push(x);
                    yValues.push(y);
                } else {
                    console.log('Ошибка: не найдено поле ввода (input) в одной из ячеек');
                }

                chart.data.labels = xValues;
                chart.data.datasets[0].data = yValues;
                chart.update();
            });
        }

        // Слушатели для автоматического обновления графика при изменении таблицы
        const tableBody = document.querySelector('tbody');
        tableBody.addEventListener('input', updateGraph);

        // Первая отрисовка графика (если данные уже есть)
        updateGraph();
    });

</script>
</html>